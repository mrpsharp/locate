var watchID;function showPosition(e){var t={lat:e.coords.latitude,lng:e.coords.longitude},o=e.coords.accuracy,n=o.toLocaleString(void 0,{maximumFractionDigits:0});250<o?showErrorButton("Accuracy is low."):hideErrorButton();let r=convertToOSGridRef(t),a;r&&(d=new Date(e.timestamp),measurementStr=`Measured at ${d.toLocaleTimeString()} on ${d.toLocaleDateString()} with an accuracy of ${n}m`,infoMessage(infoHTML=`<p>Your grid reference is</p><p class="gridref">${r}</p><p>`+measurementStr),a=`https://explore.osmaps.com/pin?lat=${t.lat}&lon=${t.lng}&zoom=16`,document.getElementById("result-links").style.display="block",document.getElementById("osmaps-link").setAttribute("href",a),new URLSearchParams(window.location.search).has("testing")&&(document.getElementById("osmaps-link").style.display="block"),document.getElementById("share-link").addEventListener("click",()=>shareLocation(r,measurementStr)),watchID||((o=document.getElementById("refresh-link")).style.display="block",o.addEventListener("click",()=>getLocation())))}function convertToOSGridRef(e){proj4.defs("EPSG:27700","+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,-125.157,542.06,0.15,0.247,0.842,-20.489 +units=m +no_defs");var t=os.Transform._checkBounds(e);if(t.valid)return e=os.Transform.fromLatLng(e),(e=os.Transform.toGridRef(e)).letters+" "+e.eastings.substring(0,3)+e.northings.substring(0,3);showErrorButton(t.message)}function shareLocation(t,e){d=new Date;t=`My location is ${t}. (${e}). View location online: `+document.getElementById("osmaps-link").getAttribute("href");if(navigator.share)try{navigator.share({text:t})}catch(e){alternateShare(t)}else alternateShare(t)}function alternateShare(e){var t,o=document.getElementById("share-text");o?o.textContent=e:((altShareDiv=document.getElementById("alt-share-div")).style.display="block",(t=document.createElement("h4")).textContent="Error sharing, copy text below",(o=document.createElement("p")).id="share-text",o.textContent=e,altShareDiv.appendChild(t),altShareDiv.appendChild(o))}function showError(e){switch(e.code){case e.PERMISSION_DENIED:showErrorButton("User denied the request for Geolocation.");break;case e.POSITION_UNAVAILABLE:showErrorButton("Location information is unavailable.");break;case e.TIMEOUT:showErrorButton("The request to get user location timed out.");break;case e.UNKNOWN_ERROR:showErrorButton("An unknown error occurred.")}}function showErrorButton(e){(errorButton=document.getElementById("error-btn")).style.display="block",errorButton.innerHTML=e+" Tap to refresh",infoMessage(infoHTML='Error finding your grid reference. You may have success with <a href="https://locate.what3words.com">What3Words Locate</a> instead'),errorButton.addEventListener("click",getLocation),document.getElementById("result-links").style.display="None"}function hideErrorButton(){document.getElementById("error-btn").style.display="None"}function infoMessage(e){document.getElementById("info-message").innerHTML=e}function getLocation(){var e;watchID&&(navigator.geolocation.clearWatch(watchID),console.log("Watch cleared")),infoMessage("Finding location..."),"geolocation"in navigator?(e={enableHighAccuracy:!0,timeout:5e3,maximumAge:0},"watchPosition"in navigator.geolocation?(watchID=navigator.geolocation.watchPosition(showPosition,showError,e),console.log("location watching")):(navigator.geolocation.getCurrentPosition(showPosition,showError,e),console.log("ono watch"))):infoMessage("Geolocation is not supported by this browser.")}"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/sw.min.js").then(function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)},function(e){console.log("ServiceWorker registration failed: ",e)})});